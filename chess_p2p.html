<!DOCTYPE html>
<html>
<head>
    <title>P2P Serverless Chess</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #222; color: #eee; font-family: monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        h2 { color: #f1c40f; margin: 5px; }
        
        #game-area { display: none; width: 100%; max-width: 400px; }
        #board { width: 100%; margin-bottom: 10px; }
        
        #lobby { background: #333; padding: 20px; border-radius: 10px; text-align: center; max-width: 350px; width: 90%; }
        input { padding: 10px; width: 70%; border-radius: 5px; border: none; text-align: center; margin-bottom: 10px; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; }
        .btn-host { background: #27ae60; color: white; }
        .btn-join { background: #3498db; color: white; }
        .btn-copy { background: #555; color: white; font-size: 12px; width: auto; }
        
        #status { font-weight: bold; color: #e74c3c; margin-bottom: 10px; }
        .id-box { background: #111; padding: 10px; border: 1px dashed #777; font-size: 14px; color: #f1c40f; margin: 10px 0; user-select: all; word-break: break-all; }
    </style>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

    <h2>âš¡ P2P Chess (Fixed)</h2>
    <div id="status">Connecting to Global Network...</div>

    <div id="lobby">
        <p>Your ID:</p>
        <div id="my-id" class="id-box">...</div>
        <button class="btn-copy" onclick="copyId()">Copy ID</button>
        
        <hr style="border-color: #444; margin: 20px 0;">
        
        <p>Challenge a Friend:</p>
        <input type="text" id="opponent-id" placeholder="Paste Opponent's ID here">
        <button class="btn-join" onclick="joinGame()">CONNECT & PLAY</button>
    </div>

    <div id="game-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>You: <b id="my-color">?</b></span>
            <span id="turn-display">Turn: White</span>
        </div>
        <div id="board"></div>
        <button onclick="location.reload()" style="background:#c0392b; color:white;">Reload / New Game</button>
    </div>

<script>
    var board = null;
    var game = new Chess();
    var peer = null;
    var conn = null;
    var myId = null;
    var myColor = 'white'; 

    // --- THE FIX: ADD GOOGLE STUN SERVERS ---
    var peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
                { url: 'stun:stun2.l.google.com:19302' }
            ]
        }
    };

    // Initialize Peer with the fix
    peer = new Peer(null, peerConfig);

    peer.on('open', function(id) {
        myId = id;
        document.getElementById('my-id').innerText = id;
        document.getElementById('status').innerText = "Online. Ready.";
        document.getElementById('status').style.color = "#2ecc71";
    });

    peer.on('error', function(err) {
        alert("Connection Error: " + err.type);
        document.getElementById('status').innerText = "Error: " + err.type;
    });

    // Handle Incoming Connection
    peer.on('connection', function(c) {
        if(conn) { c.close(); return; }
        conn = c;
        myColor = 'white'; 
        setupConnection();
    });

    function joinGame() {
        var otherId = document.getElementById('opponent-id').value.trim();
        if(!otherId) { alert("Enter an ID!"); return; }

        document.getElementById('status').innerText = "Connecting...";
        
        conn = peer.connect(otherId);
        myColor = 'black'; 
        
        conn.on('open', function() {
            setupConnection();
        });
        
        // If connection fails or takes too long
        setTimeout(function(){
            if(!conn.open) {
                document.getElementById('status').innerText = "Connection taking long... (Firewall?)";
            }
        }, 5000);
    }

    function setupConnection() {
        document.getElementById('status').innerText = "Connected!";
        startGame();

        conn.on('data', function(data) {
            if(data.type === 'move') {
                game.move(data.move);
                board.position(game.fen());
                updateStatus();
            }
        });
        
        conn.on('close', function() {
            alert("Opponent disconnected!");
            location.reload();
        });
    }

    function startGame() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('my-color').innerText = myColor.toUpperCase();
        
        var config = {
            draggable: true,
            position: 'start',
            orientation: myColor,
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        }
        board = Chessboard('board', config);
        updateStatus();
    }

    function onDragStart (source, piece) {
        if (game.game_over()) return false;
        var turn = game.turn() === 'w' ? 'white' : 'black';
        if (turn !== myColor) return false; 
    }

    function onDrop (source, target) {
        var move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        if(conn) {
            conn.send({ type: 'move', move: move });
        }
        updateStatus();
    }

    function onSnapEnd () { board.position(game.fen()); }

    function updateStatus() {
        var turn = game.turn() === 'w' ? 'White' : 'Black';
        var statusText = "Turn: " + turn;
        if (game.in_checkmate()) statusText = "Game Over! " + turn + " lost.";
        else if (game.in_draw()) statusText = "Draw!";
        else if (game.in_check()) statusText += " (CHECK!)";
        document.getElementById('turn-display').innerText = statusText;
    }

    function copyId() {
        navigator.clipboard.writeText(myId);
        alert("ID Copied!");
    }
</script>
</body>
</html>

