
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Chairs</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { color: #f1c40f; margin-bottom: 20px; }

        .container {
            background: #2c3e50;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #bdc3c7; }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: #34495e;
            border: 1px solid #7f8c8d;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            box-sizing: border-box; 
        }

        .row { display: flex; gap: 10px; flex-wrap: wrap;}
        .col { flex: 1; min-width: 100px; }

        /* Time Input Style */
        .time-input-wrapper {
            position: relative;
            background: #34495e;
            border: 1px solid #7f8c8d;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .time-input {
            background: transparent; border: none; color: white;
            width: 100%; padding: 12px; font-size: 16px; text-align: center;
        }

        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #7f8c8d; cursor: not-allowed; }

        .playlist-controls {
            display: flex; gap: 10px; margin-top: 10px; display: none;
        }
        .btn-nav { background: #2980b9; font-size: 16px; padding: 10px; }

        #status {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
            min-height: 24px;
        }
        .stop-info { color: #e74c3c !important; font-size: 22px !important; }

        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0;
            margin-top: 20px; border-radius: 10px; overflow: hidden;
            border: 2px solid #555; display: none;
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <h1>üéµ Musical Chairs Pro</h1>

    <div class="container">
        <div class="input-group">
            <label>YouTube Link (Video or Playlist):</label>
            <input type="text" id="yt-link" placeholder="Paste YouTube link here...">
        </div>

        <div class="row">
            <div class="col input-group">
                <label>Start From (MM:SS):</label>
                <div class="time-input-wrapper">
                    <input type="text" class="time-input" id="start-time" placeholder="0:05" value="0:05">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col input-group">
                <label>Min Duration (MM:SS):</label>
                <div class="time-input-wrapper">
                    <input type="text" class="time-input" id="min-time" placeholder="0:10" value="0:10">
                </div>
            </div>
            <div class="col input-group">
                <label>Max Duration (MM:SS):</label>
                <div class="time-input-wrapper">
                    <input type="text" class="time-input" id="max-time" placeholder="0:30" value="0:30">
                </div>
            </div>
        </div>

        <button id="play-btn" onclick="startRandomPlay()">‚ñ∂ LOAD & PLAY</button>
        
        <div class="playlist-controls" id="playlist-nav">
            <button class="btn-nav" onclick="prevVideo()">‚èÆ Prev Song</button>
            <button class="btn-nav" onclick="nextVideo()">Next Song ‚è≠</button>
        </div>

        <div id="status">Ready</div>

        <div class="video-wrapper" id="video-box">
            <div id="player"></div>
        </div>
    </div>

    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var stopTime = 0;
        var timerInterval = null;
        var isApiReady = false;
        var isPlaylist = false;

        function onYouTubeIframeAPIReady() { isApiReady = true; }

        // --- HELPER: Parse MM:SS to Seconds ---
        function parseTime(input) {
            if (!input) return 0;
            // Allow raw numbers (e.g., "90")
            if (!input.includes(':')) return parseInt(input) || 0;
            
            var parts = input.split(':');
            var m = parseInt(parts[0]) || 0;
            var s = parseInt(parts[1]) || 0;
            return (m * 60) + s;
        }

        // --- HELPER: Extract ID or Playlist ---
        function parseYouTubeUrl(url) {
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match(regExp);
            var videoId = (match && match[7].length == 11) ? match[7] : false;
            
            // Check for list= parameter
            var listMatch = url.match(/[?&]list=([^#&?]+)/);
            var listId = listMatch ? listMatch[1] : false;

            return { videoId: videoId, listId: listId };
        }

        function startRandomPlay() {
            if (!isApiReady) { alert("YouTube API loading..."); return; }

            var url = document.getElementById('yt-link').value;
            if (!url) { alert("Please paste a link first!"); return; }

            // Parse Times
            var startSec = parseTime(document.getElementById('start-time').value);
            var minSec = parseTime(document.getElementById('min-time').value);
            var maxSec = parseTime(document.getElementById('max-time').value);

            if (minSec >= maxSec) { alert("Min duration must be less than Max!"); return; }

            // Parse URL
            var ids = parseYouTubeUrl(url);
            if (!ids.videoId && !ids.listId) { alert("Invalid YouTube URL"); return; }

            // Setup UI
            isPlaylist = !!ids.listId;
            document.getElementById('playlist-nav').style.display = isPlaylist ? 'flex' : 'none';
            document.getElementById('video-box').style.display = 'block';
            document.getElementById('play-btn').disabled = true;
            document.getElementById('status').innerText = "Loading...";

            // Calculate Random Duration
            var randomDuration = Math.floor(Math.random() * (maxSec - minSec + 1)) + minSec;
            stopTime = randomDuration;

            var playerConfig = {
                height: '360',
                width: '640',
                playerVars: { 
                    'start': startSec,
                    'autoplay': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            };

            // Load Logic
            if (player && typeof player.loadVideoById === 'function') {
                if (isPlaylist) {
                    // If switching to playlist mode or already in it
                    player.loadPlaylist({list: ids.listId, listType: 'playlist', index: 0, startSeconds: startSec});
                } else {
                    player.loadVideoById({videoId: ids.videoId, startSeconds: startSec});
                }
                startTracking(startSec);
            } else {
                // Initial Create
                if (isPlaylist) {
                    playerConfig.playerVars.listType = 'playlist';
                    playerConfig.playerVars.list = ids.listId;
                } else {
                    playerConfig.videoId = ids.videoId;
                }
                player = new YT.Player('player', playerConfig);
            }
        }

        function onPlayerReady(event) {
            // Force start time if needed
            var startSec = parseTime(document.getElementById('start-time').value);
            event.target.seekTo(startSec);
            event.target.playVideo();
            startTracking(startSec);
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                clearInterval(timerInterval);
                document.getElementById('status').innerText = "Finished.";
                document.getElementById('play-btn').disabled = false;
            }
        }

        function startTracking(startSec) {
            if (timerInterval) clearInterval(timerInterval);

            var hasStarted = false;
            var targetTimestamp = 0;

            document.getElementById('status').innerText = "Buffering...";
            document.getElementById('status').className = "";

            timerInterval = setInterval(function() {
                if (!player || !player.getCurrentTime) return;

                var currentTime = player.getCurrentTime();
                var playerState = player.getPlayerState();

                if (playerState === 1) { // Playing
                    if (!hasStarted) {
                        // Sometimes YT starts at 0 then jumps to seek time
                        // We wait until we are roughly near requested start time
                        if(Math.abs(currentTime - startSec) < 2 || currentTime > startSec) {
                            hasStarted = true;
                            // Target = Start Time + Random Duration
                            targetTimestamp = currentTime + stopTime;
                            console.log("Target Stop: " + targetTimestamp);
                        }
                    }

                    if (hasStarted) {
                        document.getElementById('status').innerText = "Playing... üéµ";
                        document.getElementById('status').style.color = "#2ecc71";

                        if (currentTime >= targetTimestamp) {
                            player.pauseVideo();
                            clearInterval(timerInterval);
                            
                            var finalTime = currentTime.toFixed(1);
                            document.getElementById('status').innerText = "üõë STOPPED at " + finalTime + "s";
                            document.getElementById('status').className = "stop-info";
                            document.getElementById('play-btn').disabled = false;
                        }
                    }
                }
            }, 100);
        }

        // --- Playlist Controls ---
        function nextVideo() {
            if(player && isPlaylist) {
                player.nextVideo();
                resetPlayCycle();
            }
        }

        function prevVideo() {
            if(player && isPlaylist) {
                player.previousVideo();
                resetPlayCycle();
            }
        }

        function resetPlayCycle() {
            // When skipping songs, we want to restart the random timer logic
            var startSec = parseTime(document.getElementById('start-time').value);
            var minSec = parseTime(document.getElementById('min-time').value);
            var maxSec = parseTime(document.getElementById('max-time').value);
            
            // Recalculate random time
            stopTime = Math.floor(Math.random() * (maxSec - minSec + 1)) + minSec;
            
            // Reset UI and Tracker
            document.getElementById('play-btn').disabled = true;
            document.getElementById('status').className = "";
            document.getElementById('status').innerText = "Loading next track...";
            
            // Ensure we seek to custom start time for the new song
            player.seekTo(startSec);
            player.playVideo();
            startTracking(startSec);
        }

    </script>
</body>
</html>
